@startuml Berlin-Group-MCP-Comprehensive-Search-Sequence
title Berlin Group MCP Server - Comprehensive Search All Functionality Sequence

actor "User/Client" as Client
participant "MCP Server\n(Tool Handler)" as Server
participant "Tool Router" as Router
participant "SpecificationIndexer" as Indexer
participant "YamlParser" as YamlParser
participant "PdfParser" as PdfParser
database "Unified Index" as UnifiedIndex

Client -[#0277BD]> Server: callTool("search_all", {query: "payment"})
activate Server
note right of Server: Receive search_all (comprehensive) tool call

Server -[#0277BD]> Router: route_tool_call(search_all)
activate Router

Router -[#0277BD]> Indexer: searchAll(query)
activate Indexer
note right of Indexer: Parallel search across all data sources

par Search Endpoints
    Indexer -[#388E3C]> YamlParser: searchEndpoints(query)
    activate YamlParser
    note right of YamlParser
        Search in:
        - Endpoint paths
        - Operation IDs
        - Summaries
        - Descriptions
        - Tags
    end
    YamlParser -[#388E3C]> UnifiedIndex: query endpoints
    UnifiedIndex --[#388E3C]> YamlParser: matching endpoints
    YamlParser --[#388E3C]> Indexer: endpoint results
    deactivate YamlParser
else Search Schemas
    Indexer -[#D32F2F]> YamlParser: searchSchemas(query)
    activate YamlParser
    note right of YamlParser
        Search in:
        - Schema names
        - Property names
        - Descriptions
        - Type definitions
    end
    YamlParser -[#D32F2F]> UnifiedIndex: query schemas
    UnifiedIndex --[#D32F2F]> YamlParser: matching schemas
    YamlParser --[#D32F2F]> Indexer: schema results
    deactivate YamlParser
else Search Specifications
    Indexer -[#F57C00]> YamlParser: searchSpecifications(query)
    activate YamlParser
    note right of YamlParser
        Search in:
        - Spec titles
        - Spec descriptions
        - Spec versions
    end
    YamlParser -[#F57C00]> UnifiedIndex: query specs
    UnifiedIndex --[#F57C00]> YamlParser: matching specs
    YamlParser --[#F57C00]> Indexer: spec results
    deactivate YamlParser
else Search PDF Documentation
    Indexer -[#FFA500]> PdfParser: searchDocuments(query)
    activate PdfParser
    note right of PdfParser
        Search in:
        - PDF document text
        - Metadata
        - Titles
    end
    PdfParser -[#FFA500]> UnifiedIndex: query PDFs
    UnifiedIndex --[#FFA500]> PdfParser: matching documents
    PdfParser --[#FFA500]> Indexer: PDF results
    deactivate PdfParser
end

note right of Indexer: Consolidation Phase

Indexer -[#1976D2]> Indexer: consolidate_results()
note right of Indexer
    Merge results from:
    1. Endpoint matches
    2. Schema matches
    3. Specification matches
    4. PDF document matches
end

Indexer -[#1976D2]> Indexer: categorize_results()
note right of Indexer
    Organize into:
    {
        endpoints: [{...}],
        schemas: [{...}],
        specifications: [{...}],
        pdfDocuments: [{...}],
        metadata: {
            totalResults: number,
            searchDuration: ms,
            resultsByType: {...}
        }
    }
end

Indexer -[#1976D2]> Indexer: rank_results()
note right of Indexer
    Rank by:
    - Relevance score
    - Exact matches
    - Partial matches
    - Source type
end

Indexer -[#1976D2]> Indexer: limit_results()
note right of Indexer
    Apply limits:
    - Max 50 total results
    - Max 10 per category
    - By relevance
end

Indexer --[#0277BD]> Router: consolidated search results
deactivate Indexer

Router -[#0277BD]> Router: format_comprehensive_response()
note right of Router
    Create structured response:
    {
        results: {
            endpoints: [{
                path, method, summary, tags,
                specFile, relevance
            }],
            schemas: [{
                name, type, description,
                specFile, relevance
            }],
            specifications: [{
                fileName, title, version, relevance
            }],
            pdfDocuments: [{
                fileName, matches, relevance
            }]
        },
        metadata: {
            query: string,
            totalResults: number,
            resultTypes: {...},
            executionTime: ms
        }
    }
end note

Router --[#0277BD]> Server: formatted comprehensive results
deactivate Router

Server -[#0277BD]> Server: create_json_rpc_response()
Server --[#0277BD]> Client: JSON-RPC Response with All Results
deactivate Server

Client -[#1976D2]> Client: display_unified_results()
note right of Client
    Display:
    - Endpoint matches (with methods)
    - Schema definitions
    - Relevant specs
    - PDF documentation excerpts
    - Unified search summary
    - Relevance ranking
end note

@enduml